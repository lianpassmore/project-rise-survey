<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Trurivu Form Demo</title>
  <style>
    .hidden { display: none; }
  </style>
</head>
<body>
  <div id="debug-info" style="display:none"></div>
  <div id="session-display"></div>
  <div id="session-info" style="display:none"></div>
  <div id="loading">Loading...</div>
  <div id="form-container" style="display:none"></div>
  <button id="part-two-button" class="hidden" onclick="showPartTwoForm()">Continue to Part 2</button>
  <button id="finish-survey-button" class="hidden" onclick="finishSurvey()">Finish Survey</button>
  <div id="completion-message" class="hidden">Thank you for completing the survey!</div>
  <div id="part-two-form" class="hidden">
    <!-- Your second form goes here -->
  </div>
  <!-- Example Fillout form iframe container (Uncomment and change src as needed)
  <div data-fillout-id="demo">
    <iframe src="https://you.fillout.com/demo" style="width:100%;height:500px;"></iframe>
  </div>
  -->

  <script>
    // --------------------------- TRURIVU LOGIC START ---------------------------
    let formCompleted = false;
    let currentSessionId = null;
    let conversationEnded = false;
    let debugMode = window.location.search.includes('debug=true');
    // UI debug log throttling
    const debugLogQueue = [];
    let debugLogTimeout;

    function debugLog(message, data = null) {
      if (debugMode) {
        console.log(`[Trurivu Debug] ${message}`, data || '');
        debugLogQueue.push(`<div>${new Date().toLocaleTimeString()}: ${message}</div>`);
        if (!debugLogTimeout) {
          debugLogTimeout = setTimeout(() => {
            const debugEl = document.getElementById('debug-info');
            if (debugEl) {
              debugEl.style.display = 'block';
              debugEl.innerHTML += debugLogQueue.join('');
              debugLogQueue.length = 0;
            }
            debugLogTimeout = null;
          }, 300);
        }
      }
    }
    function getSessionId() {
      return window.trurivu_session ||
        localStorage.getItem('trurivu_session') ||
        sessionStorage.getItem('trurivu_session') ||
        document.body.getAttribute('data-session-id');
    }
    function storeSessionId(sessionId) {
      window.trurivu_session = sessionId;
      localStorage.setItem('trurivu_session', sessionId);
      sessionStorage.setItem('trurivu_session', sessionId);
      document.body.setAttribute('data-session-id', sessionId);
      currentSessionId = sessionId;
      debugLog('Session ID stored', sessionId);
    }
    async function createSession() {
      debugLog('Attempting to create session...');
      try {
        const response = await fetch('/api/create-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            timestamp: new Date().toISOString(),
            source: 'trurivu-form',
            userAgent: navigator.userAgent
          })
        });

        if (!response.ok) {
          throw new Error(`API responded with ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        const sessionId = data.sessionId || data.id;

        if (!sessionId) {
          throw new Error('No session ID returned from API');
        }

        debugLog('Session created successfully', sessionId);
        return sessionId;

      } catch (error) {
        console.error('Session creation failed:', error);
        debugLog('Session creation failed, using fallback', error.message);

        let fallbackId;
        if (window.crypto && window.crypto.randomUUID) {
          fallbackId = 'RISE_' + crypto.randomUUID();
        } else {
          fallbackId = 'RISE_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        debugLog('Generated fallback session ID', fallbackId);
        return fallbackId;
      }
    }
    async function initializeSession() {
      debugLog('Initializing session...');
      try {
        let sessionId = getSessionId();

        if (!sessionId) {
          sessionId = await createSession();
          storeSessionId(sessionId);
        } else {
          debugLog('Using existing session ID', sessionId);
          currentSessionId = sessionId;
        }

        if (document.getElementById('session-display'))
          document.getElementById('session-display').textContent = sessionId.substring(0, 20) + '...';
        if (document.getElementById('session-info'))
          document.getElementById('session-info').style.display = 'block';
        if (document.getElementById('loading'))
          document.getElementById('loading').style.display = 'none';
        if (document.getElementById('form-container'))
          document.getElementById('form-container').style.display = 'block';

        // Add session ID to URL parameters for form inheritance, only if not present
        const url = new URL(window.location);
        if (url.searchParams.get('session_id') !== sessionId) {
          url.searchParams.set('session_id', sessionId);
          window.history.replaceState({}, '', url);
        }

        injectSessionIdIntoForms(sessionId);

        debugLog('Session initialized successfully');
      } catch (error) {
        console.error('Session initialization failed:', error);
        debugLog('Session initialization failed', error.message);
        const loadingEl = document.getElementById('loading');
        if (loadingEl) loadingEl.textContent = 'Error setting up session. Please refresh.';
      }
    }
    function injectSessionIdIntoForms(sessionId) {
      debugLog('Injecting session ID into forms', sessionId);
      setTimeout(() => {
        const forms = document.querySelectorAll('[data-fillout-id]');
        forms.forEach(form => {
          const filloutId = form.getAttribute('data-fillout-id');
          const iframe = form.querySelector('iframe');
          if (iframe && iframe.src && !iframe.src.includes('session_id=')) {
            const newSrc = iframe.src + (iframe.src.includes('?') ? '&' : '?') + `session_id=${sessionId}`;
            iframe.src = newSrc;
            debugLog(`Updated form ${filloutId} with session_id`);
          }
        });
      }, 2000);
      const observer = new MutationObserver((mutations, obs) => {
        const iframes = document.querySelectorAll('iframe[src*="fillout.com"]');
        iframes.forEach(iframe => {
          if (!iframe.src.includes('session_id=') && sessionId) {
            iframe.src += (iframe.src.includes('?') ? '&' : '?') + `session_id=${sessionId}`;
            debugLog('Added session_id to dynamically loaded form');
          }
        });
      });
      observer.observe(document.body, { childList: true, subtree: true });
      setTimeout(() => observer.disconnect(), 10000);
    }
    function showPartTwoForm() {
      const button = document.getElementById('part-two-button');
      const finishButton = document.getElementById('finish-survey-button');
      const form = document.getElementById('part-two-form');
      const sessionId = getSessionId();

      debugLog('Showing Part Two form', sessionId);

      if (button) button.classList.add('hidden');
      if (finishButton) finishButton.classList.add('hidden');
      if (form) form.classList.remove('hidden');

      const url = new URL(window.location);
      url.searchParams.set('session_id', sessionId);
      window.history.replaceState({}, '', url);
    }
    function finishSurvey() {
      debugLog('Finishing survey');

      const partTwoBtn = document.getElementById('part-two-button');
      if (partTwoBtn) partTwoBtn.classList.add('hidden');
      const finishBtn = document.getElementById('finish-survey-button');
      if (finishBtn) finishBtn.classList.add('hidden');
      const completionMsg = document.getElementById('completion-message');
      if (completionMsg) completionMsg.classList.remove('hidden');

      const sessionId = getSessionId();
      if (sessionId) {
        fetch('/api/survey-completed', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionId: sessionId,
            timestamp: new Date().toISOString(),
            completionType: 'finish_button'
          })
        }).catch(error => {
          debugLog('Error logging survey completion', error.message);
        });
      }
    }
    function initializeElevenLabs() {
      const sessionId = getSessionId();
      if (!sessionId) {
        debugLog('ElevenLabs init failed - no session ID');
        return;
      }

      debugLog('Initializing ElevenLabs widget', sessionId);

      if (!document.getElementById('convai-widget-chat')) {
        const widget = document.createElement('elevenlabs-convai');
        widget.setAttribute('agent-id', 'agent_6301k3m6e0are30s5w4wbkx0zzxv');
        widget.setAttribute('id', 'convai-widget-chat');
        widget.setAttribute('data-session-id', sessionId);
        document.body.appendChild(widget);
        debugLog('ElevenLabs widget created and ready');
      }

      setTimeout(() => {
        const errorMessages = document.querySelectorAll('div');
        errorMessages.forEach(msg => {
          if (msg.textContent && msg.textContent.includes('Voice Assistant Not Available')) {
            msg.remove();
            debugLog('Removed error message');
          }
        });
      }, 3000);
    }
    function pollForWidget() {
      if (window.customElements && window.customElements.get('elevenlabs-convai')) {
        initializeElevenLabs();
      } else {
        setTimeout(pollForWidget, 200);
      }
    }
    function handleFormCompletion(source, formData = null) {
      if (formCompleted) {
        debugLog('Form already completed, ignoring duplicate event');
        return;
      }
      formCompleted = true;
      debugLog('Form completion detected', source);
      debugLog('Form data will be handled by N8N webhook from Fillout');

      const partTwoButton = document.getElementById('part-two-button');
      if (partTwoButton) {
        partTwoButton.classList.remove('hidden');
        debugLog('Part Two button shown');
      }
      pollForWidget();
      initializeConversationLogging();
    }
    function showFinishButton() {
      debugLog('Showing finish survey button');
      const finishButton = document.getElementById('finish-survey-button');
      if (finishButton && formCompleted) {
        finishButton.classList.remove('hidden');
      }
    }
    function initializeConversationLogging() {
      debugLog('Initializing conversation logging');

      window.addEventListener('message', function(event) {
        if (
          !event.origin ||
          (event.origin !== 'https://elevenlabs.com' &&
            event.origin !== 'https://widget.elevenlabs.com')
        ) {
          return;
        }

        const { type, data } = event.data || {};
        if (type && currentSessionId) {
          debugLog('Received ElevenLabs event', type);

          if (
            type === 'conversation_ended' ||
            type === 'call_ended' ||
            type === 'widget_closed'
          ) {
            conversationEnded = true;
            showFinishButton();
          }
          debugLog('ElevenLabs event logged locally, N8N will handle database storage');
        }
      }, { passive: true });
    }
    window.addEventListener('message', function(event) {
      if (event.origin && (
        event.origin.includes('youtube.com') ||
        event.origin.includes('google.com') ||
        event.origin.includes('googlevideo.com')
      )) {
        return;
      }

      if (!event.origin || !event.origin.includes('fillout.com')) {
        return;
      }

      if (event.data) {
        const data = event.data;

        if (data.channel === 'form_channel' && data.state === 'submitted') {
          debugLog('Received Fillout completion message (original)', data);
          handleFormCompletion('original format', data.formData);
          return;
        }

        if (
          data.type === 'form_submitted' ||
          data.event === 'submitted' ||
          data.state === 'complete' ||
          data.status === 'submitted' ||
          data.action === 'submit' ||
          (data.fillout && data.fillout.submitted) ||
          (data.form && data.form.submitted)
        ) {
          debugLog('Received Fillout completion message (common)', data);
          handleFormCompletion('common format', data);
          return;
        }

        const messageStr = JSON.stringify(data).toLowerCase();
        if (messageStr.includes('submit')) {
          debugLog('Received potential submission message', data);
          if (messageStr.includes('success') || messageStr.includes('complete') || messageStr.includes('thank')) {
            handleFormCompletion('keyword match', data);
            return;
          }
          if (debugMode) {
            debugLog('Received Fillout submit message', data.type || 'unknown');
          }
        } else if (debugMode && Math.random() < 0.05) {
          debugLog('Received Fillout message (sampled)', data.type || 'unknown');
        }
      }
    }, { passive: true });
    let formCheckInterval;
    function startFormMonitoring() {
      debugLog('Starting form monitoring');

      formCheckInterval = setInterval(() => {
        const filloutContainer = document.querySelector('[data-fillout-id]');
        if (filloutContainer) {
          const completionIndicators = [
            'thank you',
            'submitted',
            'complete',
            'success',
            'received'
          ];

          const containerText = filloutContainer.textContent || '';
          for (let indicator of completionIndicators) {
            if (containerText.toLowerCase().includes(indicator)) {
              clearInterval(formCheckInterval);
              debugLog('Form completion detected via DOM monitoring', indicator);
              handleFormCompletion('DOM monitoring - ' + indicator);
              return;
            }
          }
        }

        const currentUrl = window.location.href;
        if (currentUrl.includes('submitted') || currentUrl.includes('complete') || currentUrl.includes('thank')) {
          clearInterval(formCheckInterval);
          debugLog('Form completion detected via URL monitoring');
          handleFormCompletion('URL monitoring');
          return;
        }
      }, 1500);

      if (debugMode) {
        setTimeout(() => {
          console.log('MANUAL TRIGGER: Type triggerFormCompletion() in console to test form completion');
        }, 5000);
      }
    }
    window.triggerFormCompletion = function() {
      if (debugMode) {
        debugLog('Manual form completion triggered');
        handleFormCompletion('manual trigger');
      }
    };
    setTimeout(() => {
      debugLog('Loading ElevenLabs widget script');
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/@elevenlabs/convai-widget-embed';
      script.type = 'text/javascript';
      script.async = true;
      script.onload = () => debugLog('ElevenLabs script loaded');
      script.onerror = () => debugLog('ElevenLabs script failed to load');
      document.head.appendChild(script);
    }, 2000);
    window.addEventListener('load', () => {
      debugLog('Page loaded, initializing application');
      initializeSession();
      startFormMonitoring();
    });
    window.trurivuDebug = {
      getSessionId: getSessionId,
      getCurrentSession: () => currentSessionId,
      testSessionCreation: createSession,
      showDebugInfo: () => {
        const debugEl = document.getElementById('debug-info');
        if (debugEl) debugEl.style.display = 'block';
      },
      getStoredSessions: () => ({
        localStorage: localStorage.getItem('trurivu_session'),
        sessionStorage: sessionStorage.getItem('trurivu_session'),
        window: window.trurivu_session,
        bodyAttr: document.body.getAttribute('data-session-id')
      })
    };
    // ---------------------------- TRURIVU LOGIC END -----------------------------
  </script>
</body>
</html>
