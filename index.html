// Global state management
let formCompleted = false;
let currentSessionId = null;
let conversationEnded = false;
let debugMode = window.location.search.includes('debug=true');

// Debug logging function
function debugLog(message, data = null) {
    if (debugMode) {
        console.log(`[Trurivu Debug] ${message}`, data || '');
        const debugEl = document.getElementById('debug-info');
        if (debugEl) {
            debugEl.style.display = 'block';
            debugEl.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
        }
    }
}

// Session management functions
function getSessionId() {
    return window.trurivu_session || 
           localStorage.getItem('trurivu_session') || 
           sessionStorage.getItem('trurivu_session') ||
           document.body.getAttribute('data-session-id');
}

function storeSessionId(sessionId) {
    window.trurivu_session = sessionId;
    localStorage.setItem('trurivu_session', sessionId);
    sessionStorage.setItem('trurivu_session', sessionId);
    document.body.setAttribute('data-session-id', sessionId);
    currentSessionId = sessionId;
    debugLog('Session ID stored', sessionId);
}

async function createSession() {
    debugLog('Attempting to create session...');
    try {
        const response = await fetch('/api/create-session', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json' 
            },
            body: JSON.stringify({ 
                timestamp: new Date().toISOString(),
                source: 'trurivu-form',
                userAgent: navigator.userAgent
            })
        });
        
        if (!response.ok) {
            throw new Error(`API responded with ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        const sessionId = data.sessionId || data.id;
        
        if (!sessionId) {
            throw new Error('No session ID returned from API');
        }
        
        debugLog('Session created successfully', sessionId);
        return sessionId;
        
    } catch (error) {
        console.error('Session creation failed:', error);
        debugLog('Session creation failed, using fallback', error.message);
        
        // Fallback session ID generation
        const fallbackId = 'RISE_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        debugLog('Generated fallback session ID', fallbackId);
        return fallbackId;
    }
}

async function initializeSession() {
    debugLog('Initializing session...');
    try {
        let sessionId = getSessionId();
        
        if (!sessionId) {
            sessionId = await createSession();
            storeSessionId(sessionId);
        } else {
            debugLog('Using existing session ID', sessionId);
            currentSessionId = sessionId;
        }
        
        // Update UI
        document.getElementById('session-display').textContent = sessionId.substring(0, 20) + '...';
        document.getElementById('session-info').style.display = 'block';
        document.getElementById('loading').style.display = 'none';
        document.getElementById('form-container').style.display = 'block';
        
        // Add session ID to URL parameters for form inheritance
        const url = new URL(window.location);
        url.searchParams.set('session_id', sessionId);
        window.history.replaceState({}, '', url);
        
        // Inject session_id into Fillout forms
        injectSessionIdIntoForms(sessionId);
        
        debugLog('Session initialized successfully');
        
    } catch (error) {
        console.error('Session initialization failed:', error);
        debugLog('Session initialization failed', error.message);
        document.getElementById('loading').textContent = 'Error setting up session. Please refresh.';
    }
}

// Function to manually inject session_id into Fillout forms
function injectSessionIdIntoForms(sessionId) {
    debugLog('Injecting session ID into forms', sessionId);
    
    // Wait for Fillout to load, then inject session_id
    setTimeout(() => {
        const forms = document.querySelectorAll('[data-fillout-id]');
        forms.forEach(form => {
            const filloutId = form.getAttribute('data-fillout-id');
            const iframe = form.querySelector('iframe');
            
            if (iframe && iframe.src && !iframe.src.includes('session_id=')) {
                const newSrc = iframe.src + (iframe.src.includes('?') ? '&' : '?') + `session_id=${sessionId}`;
                iframe.src = newSrc;
                debugLog(`Updated form ${filloutId} with session_id`);
            }
        });
    }, 2000);
    
    // Monitor for dynamically loaded forms
    const observer = new MutationObserver(() => {
        const iframes = document.querySelectorAll('iframe[src*="fillout.com"]');
        iframes.forEach(iframe => {
            if (!iframe.src.includes('session_id=')) {
                iframe.src += (iframe.src.includes('?') ? '&' : '?') + `session_id=${sessionId}`;
                debugLog('Added session_id to dynamically loaded form');
            }
        });
    });
    
    observer.observe(document.body, { childList: true, subtree: true });
}

// Show Part Two form function
function showPartTwoForm() {
    const button = document.getElementById('part-two-button');
    const finishButton = document.getElementById('finish-survey-button');
    const form = document.getElementById('part-two-form');
    const sessionId = getSessionId();
    
    debugLog('Showing Part Two form', sessionId);
    
    button.classList.add('hidden');
    finishButton.classList.add('hidden');
    form.classList.remove('hidden');
    
    // Ensure session ID is in URL for the second form
    const url = new URL(window.location);
    url.searchParams.set('session_id', sessionId);
    window.history.replaceState({}, '', url);
}

// Finish survey function - lightweight completion tracking via Vercel API
function finishSurvey() {
    debugLog('Finishing survey');
    
    document.getElementById('part-two-button').classList.add('hidden');
    document.getElementById('finish-survey-button').classList.add('hidden');
    document.getElementById('completion-message').classList.remove('hidden');
    
    const sessionId = getSessionId();
    if (sessionId) {
        fetch('/api/survey-completed', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                sessionId: sessionId,
                timestamp: new Date().toISOString(),
                completionType: 'finish_button'
            })
        }).catch(error => {
            debugLog('Error logging survey completion', error.message);
        });
    }
}

// ElevenLabs widget initialization - NO ERROR POPUP
function initializeElevenLabs() {
    const sessionId = getSessionId();
    if (!sessionId) {
        debugLog('ElevenLabs init failed - no session ID');
        return;
    }
    
    debugLog('Initializing ElevenLabs widget', sessionId);
    
    if (!document.getElementById('convai-widget-chat')) {
        const widget = document.createElement('elevenlabs-convai');
        widget.setAttribute('agent-id', 'agent_6301k3m6e0are30s5w4wbkx0zzxv');
        widget.setAttribute('id', 'convai-widget-chat');
        widget.setAttribute('data-session-id', sessionId);
        document.body.appendChild(widget);
        debugLog('ElevenLabs widget created and ready');
    }
    
    // Clean up any error messages after widget has had time to load
    setTimeout(() => {
        const errorMessages = document.querySelectorAll('div');
        errorMessages.forEach(msg => {
            if (msg.textContent && msg.textContent.includes('Voice Assistant Not Available')) {
                msg.remove();
                debugLog('Removed error message');
            }
        });
    }, 3000); // Longer delay to let widget load first
}

function pollForWidget() {
    if (window.customElements && window.customElements.get('elevenlabs-convai')) {
        initializeElevenLabs();
    } else {
        setTimeout(pollForWidget, 200);
    }
}

// Form completion handling - NO API CALLS, N8N handles all form data
function handleFormCompletion(source, formData = null) {
    if (formCompleted) {
        debugLog('Form already completed, ignoring duplicate event');
        return;
    }
    
    formCompleted = true;
    debugLog('Form completion detected', source);
    
    // Note: Form data flows Fillout → N8N → Supabase
    // No redundant Vercel API calls needed
    debugLog('Form data will be handled by N8N webhook from Fillout');
    
    // Show the Part Two button
    const partTwoButton = document.getElementById('part-two-button');
    if (partTwoButton) {
        partTwoButton.classList.remove('hidden');
        debugLog('Part Two button shown');
    }
    
    // Initialize ElevenLabs widget (only after form completion)
    pollForWidget();
    initializeConversationLogging();
}

function showFinishButton() {
    debugLog('Showing finish survey button');
    const finishButton = document.getElementById('finish-survey-button');
    if (finishButton && formCompleted) {
        finishButton.classList.remove('hidden');
    }
}

function initializeConversationLogging() {
    debugLog('Initializing conversation logging');
    
    window.addEventListener('message', function(event) {
        // Only listen to ElevenLabs events
        if (!event.origin || 
            (event.origin !== 'https://elevenlabs.com' && 
             event.origin !== 'https://widget.elevenlabs.com')) {
            return;
        }
        
        const { type, data } = event.data || {};
        if (type && currentSessionId) {
            debugLog('Received ElevenLabs event', type);
            
            // Check if conversation has ended
            if (type === 'conversation_ended' || type === 'call_ended' || type === 'widget_closed') {
                conversationEnded = true;
                showFinishButton();
            }
            
            // Note: ElevenLabs sends transcript data directly to N8N webhook
            // We just log locally for debugging, N8N handles database storage
            debugLog('ElevenLabs event logged locally, N8N will handle database storage');
        }
    }, { passive: true });
}

// Enhanced message listener for form completion with better detection
window.addEventListener('message', function(event) {
    // Filter out problematic origins
    if (event.origin && (
        event.origin.includes('youtube.com') ||
        event.origin.includes('google.com') ||
        event.origin.includes('googlevideo.com')
    )) {
        return;
    }
    
    // Only process messages from Fillout
    if (!event.origin || !event.origin.includes('fillout.com')) {
        return;
    }
    
    if (event.data) {
        const data = event.data;
        
        // More aggressive form completion detection
        if (data.channel === 'form_channel' && data.state === 'submitted') {
            debugLog('Received Fillout completion message (original)', data);
            handleFormCompletion('original format', data.formData);
            return;
        }
        
        if (data.type === 'form_submitted' || 
            data.event === 'submitted' || 
            data.state === 'complete' ||
            data.status === 'submitted' ||
            data.action === 'submit' ||
            (data.fillout && data.fillout.submitted) ||
            (data.form && data.form.submitted)) {
            debugLog('Received Fillout completion message (common)', data);
            handleFormCompletion('common format', data);
            return;
        }
        
        // Check for any submit-related messages
        const messageStr = JSON.stringify(data).toLowerCase();
        if (messageStr.includes('submit')) {
            debugLog('Received potential submission message', data);
            if (messageStr.includes('success') || messageStr.includes('complete') || messageStr.includes('thank')) {
                handleFormCompletion('keyword match', data);
                return;
            }
            // Still log other submit messages for debugging
            if (debugMode) {
                debugLog('Received Fillout submit message', data.type || 'unknown');
            }
        } else if (debugMode && Math.random() < 0.05) { // 5% sampling for non-submit messages
            debugLog('Received Fillout message (sampled)', data.type || 'unknown');
        }
    }
}, { passive: true });

// Fallback form monitoring with manual trigger option
let formCheckInterval;
function startFormMonitoring() {
    debugLog('Starting form monitoring');
    
    formCheckInterval = setInterval(() => {
        const filloutContainer = document.querySelector('[data-fillout-id]');
        if (filloutContainer) {
            const completionIndicators = [
                'thank you',
                'submitted',
                'complete',
                'success',
                'received'
            ];
            
            const containerText = filloutContainer.textContent || '';
            for (let indicator of completionIndicators) {
                if (containerText.toLowerCase().includes(indicator)) {
                    clearInterval(formCheckInterval);
                    debugLog('Form completion detected via DOM monitoring', indicator);
                    handleFormCompletion('DOM monitoring - ' + indicator);
                    return;
                }
            }
        }
        
        const currentUrl = window.location.href;
        if (currentUrl.includes('submitted') || currentUrl.includes('complete') || currentUrl.includes('thank')) {
            clearInterval(formCheckInterval);
            debugLog('Form completion detected via URL monitoring');
            handleFormCompletion('URL monitoring');
            return;
        }
    }, 1500);
    
    // Add manual trigger for testing - remove this after testing
    if (debugMode) {
        setTimeout(() => {
            console.log('MANUAL TRIGGER: Type triggerFormCompletion() in console to test form completion');
        }, 5000);
    }
}

// Manual form completion trigger for testing (only available in debug mode)
window.triggerFormCompletion = function() {
    if (debugMode) {
        debugLog('Manual form completion triggered');
        handleFormCompletion('manual trigger');
    }
};

// ElevenLabs widget loading
setTimeout(() => {
    debugLog('Loading ElevenLabs widget script');
    const script = document.createElement('script');
    script.src = 'https://unpkg.com/@elevenlabs/convai-widget-embed';
    script.type = 'text/javascript';
    script.async = true;
    script.onload = () => debugLog('ElevenLabs script loaded');
    script.onerror = () => debugLog('ElevenLabs script failed to load');
    document.head.appendChild(script);
}, 2000);

// Main initialization
window.addEventListener('load', () => {
    debugLog('Page loaded, initializing application');
    initializeSession();
    startFormMonitoring();
});

// Debugging helpers (available in console)
window.trurivuDebug = {
    getSessionId: getSessionId,
    getCurrentSession: () => currentSessionId,
    testSessionCreation: createSession,
    showDebugInfo: () => {
        const debugEl = document.getElementById('debug-info');
        if (debugEl) debugEl.style.display = 'block';
    },
    getStoredSessions: () => ({
        localStorage: localStorage.getItem('trurivu_session'),
        sessionStorage: sessionStorage.getItem('trurivu_session'),
        window: window.trurivu_session,
        bodyAttr: document.body.getAttribute('data-session-id')
    })
};
